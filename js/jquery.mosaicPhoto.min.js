/**
 * Class: mosaicPhoto
 * Use: insert preview photos mosaically into div
 * Author: Anton Syuvaev (http://h8every1.ru)
 * Company: Elustro (http://elustro.ru)
 * Date: 31.05.2012
 * Version: 1.1.0
 */
(function(d){var h=function(b,a){function c(){for(;1<a.ratio;)a.ratio/=100;var e=d('<div class="'+a.activeClass+'"/>').appendTo(k);q=e.outerWidth(!0);r=e.outerHeight(!0);h();t=Math.min(Math.floor(a.rows*a.cols*a.ratio),a.maxImages);f(o);x();y();z()}function f(a){if(!a||!l.hasOwnProperty(a)||"object"!==typeof l[a])a:{for(var b in l)if(l.hasOwnProperty(b)){a=b;break a}alert("No image data!");a=null}o=a}function h(){if(!a.dynamic)return!0;var e=Math.floor(k.width()/q),b=Math.floor(k.height()/r);return b!==
    a.rows||e!==a.cols?(a.rows=b,a.cols=e,!0):!1}function m(){var e=Math.min(t,l[o].length);if(!e)return!1;for(var b=u(l[o],e),c=[],i=a.rows*a.cols,j=0;j<i;j++)c[j]=j;for(var c=u(c,e).sort(function(a,b){return a-b}),e=0,f=c.shift(),i=b.shift(),g="",j=0;j<a.rows;j++)for(var h=0;h<a.cols;h++)if(c.length)e===f&&(f="object"===typeof i,g+='<div class="'+a.activeClass+'" style="top:'+j*r+"px;left:"+h*q+"px;background-image:url("+(f?i[0]:i)+')">'+(f&&i[1]?'<a href="'+i[1]+'"></a>':"")+"</div>",f=c.shift(),i=
    b.shift()),e++;else break;k.html("");d(g).appendTo(k).fadeIn(a.fadeTime);a.showAllCallback();return!0}function x(){p.unbind("resize"+g);a.dynamic&&p.bind("resize"+g,function(){if(h())return m()})}function y(){v.undelegate(a.listenersEvents+g);w=d(a.listeners);w.length&&v.delegate(a.listeners,a.listenersEvents+g,function(b){f(d(this).attr("rel"));m();a.listenerCallback();return b.preventDefault()}).delegate(a.listeners,"click"+g,function(a){return a.preventDefault()})}function z(){n&&clearInterval(n);
  a.auto&&(n=setInterval(function(){return m()},a.timer+a.fadeTime))}function u(a,b){for(var c=[],d=a.slice();d.length;)c.push(d.splice(Math.random()*d.length,1)[0]);return c.slice(0,b)}var s=this,p=d(window),v=d(document),k=d('<div style="height:100%;position:relative"></div>').appendTo(b),l=a.images,t,o,q=0,r=0,n,w,g=".mosaicphoto"+(new Date).getTime();this.getOptions=function(b){return"undefined"===typeof b?a:a[b]};this.setOptions=function(b){p.undelegate(a.listenersEvents+g);d.extend(a,b);c();return s};
  this.selectCategory=function(a){f(a);return s};this.refresh=function(){m();return s};this.destroy=function(){p.undelegate(g);n&&clearInterval(n);k.remove();b.removeData("mosaicphoto");return b};c();m()};mosaicPhoto.defaults={rows:3,cols:8,ratio:0.8,maxImages:24,dynamic:!0,activeClass:"mosaicItem",fadeTime:750,auto:!1,timer:3E3,preload:!0,images:{},listeners:"",listenersEvents:"click",showAllCallback:function(){},listenerCallback:function(){}};d.fn.mosaicPhoto=function(b){var a=this.data("mosaicphoto");if(a)return"object"===
    typeof b&&a.setOptions(b),a;b=d.extend({},mosaicPhoto.defaults,b);this.each(function(){var c=d(this);a=new h(c,b);c.data("mosaicphoto",a)});b.preload&&d.each(b.images,function(a,b){d.preloadMosaicPhotoImages(b)});return this};d.preloadMosaicPhotoImages=function(b){for(var a=b.length,c=0;c<a;c++){var f="object"===typeof b[c]?b[c][0]:b[c];d(new Image).attr("src",f)}return!0}})(jQuery);